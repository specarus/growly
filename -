export const dynamic = "force-dynamic";

import { headers } from "next/headers";
import { notFound, redirect } from "next/navigation";

import CreateTodoPage from "../../create/create-todo-page";
import { auth } from "@/lib/auth";
import { prisma } from "@/lib/prisma";

interface EditTodoPageProps {
  params: {
    id: string;
  };
}

const buildInitial = (todo: any) => ({
  id: todo.id as string,
  title: todo.title as string,
  description: todo.description as string | null,
  category: todo.category as string | null,
  priority: todo.priority as string | null,
  status: todo.status as string | null,
  dueAt: todo.dueAt ? (todo.dueAt as Date).toISOString() : null,
  durationMinutes: todo.durationMinutes as number | null,
  location: todo.location as string | null,
  reminder: todo.reminder as string | null,
  recurrence: todo.recurrence as string | null,
  tags: todo.tags as string | null,
});

export default async function EditTodoPage({ params }: EditTodoPageProps) {
  const session = await auth.api.getSession({
    headers: await headers(),
  });

  if (!session) {
    redirect("/");
  }

  const todoId = typeof params?.id === "string" ? params.id : null;
  if (!todoId) {
    notFound();
  }

  const todo = await prisma.todo.findUnique({
    where: {
      id_userId: {
        id: todoId,
        userId: session.user.id,
      },
    },
  });

  if (!todo) {
    notFound();
  }

  return <CreateTodoPage mode="edit" initialTodo={buildInitial(todo)} />;
}
